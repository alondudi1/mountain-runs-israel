<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Mountain Runs Israel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
  </script>

  <style>
    body { margin: 0; font-family: sans-serif; }
    #app { display: flex; height: 100vh; flex-direction: row-reverse; }

    #map { flex: 1; }
    #sidebar {
      width: 320px;
      border-left: 1px solid #ddd;
      padding: 10px;
      overflow-y: auto;
      background: #fff;
    }
    .route-item {
      padding: 6px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .route-item:hover {
      background: #f0f0f0;
    }
    .region-title {
      font-weight: bold;
      margin-top: 12px;
    }
    .home-btn {
      margin: 10px 0;
      padding: 6px;
      cursor: pointer;
    }
    .status {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }
  </style>
</head>

<body>
<div id="app">
  <div id="map"></div>
  <div id="sidebar">
    <button class="home-btn" id="homeBtn">↩ חזרה לכל ישראל</button>
    <div id="routesList"></div>
    <div class="status" id="status">טוען…</div>
  </div>
</div>

<script>
(async function () {

  /* ========= מפה ========= */
  const map = L.map('map').setView([31.8, 35.0], 8);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '© OpenStreetMap'
  }).addTo(map);

  const routesLayer = L.layerGroup().addTo(map);

  /* ========= עזרים ========= */
  async function loadJSON(path) {
    const res = await fetch(path, { cache: 'no-store' });
    if (!res.ok) throw new Error(`Failed to load ${path}`);
    return res.json();
  }

  async function loadGeometry(relPath) {
    return loadJSON('data/' + relPath);
  }

  const statusEl = document.getElementById('status');
  const listEl   = document.getElementById('routesList');
  const homeBtn  = document.getElementById('homeBtn');

  /* ========= טעינת מסלולים ========= */
  let routes;
  try {
    routes = await loadJSON('data/routes.json');
    statusEl.textContent = `נטענו ${routes.length} מסלולים`;
  } catch (e) {
    statusEl.textContent = e.message;
    return;
  }

  /* ========= ציור מסלולים ========= */
  const routeMap = {};

  for (const r of routes) {
    const geom = await loadGeometry(r.geometry_file);

    let latlngs = [];

    if (geom.type === 'LineString') {
      latlngs = geom.coordinates.map(([lon, lat]) => [lat, lon]);
    } else if (geom.type === 'MultiLineString') {
      geom.coordinates.forEach(line =>
        line.forEach(([lon, lat]) => latlngs.push([lat, lon]))
      );
    }

    if (latlngs.length < 2) continue;

    const line = L.polyline(latlngs, { weight: 4 }).addTo(routesLayer);
    line.bindTooltip(r.name, { sticky: true });

    routeMap[r.id] = line;

    line.on('click', () => focusRoute(r.id));
  }

  /* ========= רשימה לפי אזורים ========= */
  function renderList() {
    listEl.innerHTML = '';
    const byRegion = {};

    routes.forEach(r => {
      if (!byRegion[r.region]) byRegion[r.region] = [];
      byRegion[r.region].push(r);
    });

    for (const region of Object.keys(byRegion)) {
      const title = document.createElement('div');
      title.className = 'region-title';
      title.textContent = region;
      listEl.appendChild(title);

      byRegion[region].forEach(r => {
        const item = document.createElement('div');
        item.className = 'route-item';
        item.textContent = r.name;
        item.onclick = () => focusRoute(r.id);
        listEl.appendChild(item);
      });
    }
  }

  renderList();

  /* ========= מיקוד ========= */
  function focusRoute(id) {
    const line = routeMap[id];
    if (!line) return;
    map.fitBounds(line.getBounds(), { padding: [30, 30] });
  }

  homeBtn.onclick = () => {
    map.setView([31.8, 35.0], 8);
  };

})();
</script>
</body>
</html>
