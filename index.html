<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-166000066"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-166000066');
  </script>
  <title>Mountain Runs Israel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
    #app { display: flex; height: 100vh; flex-direction: row-reverse; }
    #map { flex: 1; }

    #sidebar {
      width: 320px;
      border-left: 1px solid #ddd;
      padding: 10px;
      overflow-y: auto;
      background: #fff;
      box-sizing: border-box;
    }

    /* התוספת היחידה ב-CSS: הגדרת גודל ללוגו */
    .sidebar-logo {
      width: 100%;
      height: auto;
      display: block;
      margin-bottom: 15px;
      border-radius: 8px;
    }

    .region-title {
      font-weight: 800;
      margin: 14px 0 6px;
      opacity: .85;
    }

    .route-item {
      padding: 8px 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .route-item:hover {
      background: #f5f5f5;
    }

    .status {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
    }

    @media (max-width: 800px) {
      #app { flex-direction: column; }
      #sidebar { width: 100%; height: 40vh; border-left: none; border-top: 1px solid #ddd; }
      #map { height: 60vh; }
    }
    .leaflet-top.leaflet-left .leaflet-control {
      margin-bottom: 6px;
    }
    /* ===== Preview Card ===== */
    .route-preview {
      position: fixed;
      right: 16px;
      bottom: 16px;
      width: 320px;
      max-width: calc(100% - 32px);
    
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      padding: 12px;
    
      z-index: 1200;
    
      transform: translateY(120%);
      opacity: 0;
      transition: transform 0.35s ease, opacity 0.25s ease;
    }
    
    .route-preview.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .route-preview.hidden { display: none; }
    
    .rp-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
    }
    
    .rp-title { font-weight: 800; font-size: 15px; margin-bottom: 4px; }
    .rp-meta  { font-size: 12px; color: #666; line-height: 1.3; }
    
    .rp-close {
      border: 0;
      background: transparent;
      cursor: pointer;
      font-size: 20px;
      line-height: 20px;
      padding: 4px 6px;
      color: #444;
    }
    
    .rp-btn {
      display: block;
      width: 100%;
      box-sizing: border-box;
    
      margin-top: 10px;
      padding: 10px 12px;
    
      background: #d32f2f;
      color: #fff;
      text-decoration: none;
      font-weight: 700;
      font-size: 14px;
      text-align: center;
    
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,.2);
    }

    .rp-btn:hover { background: #b71c1c; }
    .rp-meta:empty { display: none; }

  </style>
</head>

<body>
<div id="app">
  <div id="map"></div>
  <div id="sidebar">
    <img src="IMG_9648.jpeg" alt="Run-IL Trail Bank" class="sidebar-logo">
    
    <div style="font-weight:800; margin-bottom:8px;">מסלולים</div>
    <div id="routesList"></div>
    <div class="status" id="status">טוען…</div>
  </div>
</div>

  <div id="routePreview" class="route-preview hidden">
    <div class="rp-top">
      <div class="rp-text">
        <div id="previewTitle" class="rp-title"></div>
        <div id="previewMeta" class="rp-meta"></div>
      </div>
      <button id="previewClose" class="rp-close" title="סגור">×</button>
    </div>
  
    <a id="previewBtn" class="rp-btn" href="#">לפרטי המסלול →</a>
  </div>

<script>
(async function () {

  const statusEl = document.getElementById('status');
  const listEl   = document.getElementById('routesList');

  // ===== Preview Card refs =====
  const preview = document.getElementById('routePreview');
  const titleEl = document.getElementById('previewTitle');
  const metaEl  = document.getElementById('previewMeta');
  const btnEl   = document.getElementById('previewBtn');
  const closeEl = document.getElementById('previewClose');
  
  function hidePreview() {
    preview.classList.remove('show');
    setTimeout(() => preview.classList.add('hidden'), 250);
  }
  
  function showPreview(routeId, routes) {
    const r = routes.find(x => x.id === routeId);
    if (!r) return;
  
    titleEl.textContent = r.name || routeId;
  
    btnEl.href = `route.html?id=${encodeURIComponent(routeId)}`;
  
    preview.classList.remove('hidden');
    requestAnimationFrame(() => preview.classList.add('show'));
  }
  
  closeEl.addEventListener('click', hidePreview);

  if (!window.L) {
    statusEl.textContent = 'Leaflet לא נטען';
    return;
  }

  // ===== מפה =====
  const ISRAEL_VIEW = { center: [31.8, 35.0], zoom: 8 };
  const map = L.map('map').setView(ISRAEL_VIEW.center, ISRAEL_VIEW.zoom);
  map.on('click', () => hidePreview());

  // ===== כפתור חזרה לתצוגת פתיחה =====
  const backControl = L.control({ position: 'topleft' });
  backControl.onAdd = function () {
    const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
    const btn = L.DomUtil.create('a', '', container);
    btn.href = '#';
    btn.title = 'חזרה לכל ישראל';
    btn.innerHTML = '↺';
    btn.style.fontSize = '18px';
    btn.style.lineHeight = '30px';
    btn.style.textAlign = 'center';
    btn.style.width = '30px';
    btn.style.height = '30px';
    L.DomEvent.disableClickPropagation(container);
    L.DomEvent.on(btn, 'click', (e) => {
      L.DomEvent.preventDefault(e);
      map.setView(ISRAEL_VIEW.center, ISRAEL_VIEW.zoom);
    });
    return container;
  };
  backControl.addTo(map);

  // ===== שכבות מפה (Base Layers) =====
  const ihm = L.tileLayer('https://israelhiking.osm.org.il/Hebrew/Tiles/{z}/{x}/{y}.png', {
    maxZoom: 16,
    attribution: '© Israel Hiking Map'
  }).addTo(map);

  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap'
  });

  L.control.layers({ 'סימון שבילים (IHM)': ihm, 'מפת רחובות (OSM)': osm }, null, { position: 'topright' }).addTo(map);

  const routesLayer = L.layerGroup().addTo(map);

  async function loadJSON(path) {
    const res = await fetch(path, { cache: 'no-store' });
    if (!res.ok) throw new Error(`Failed to load ${path}`);
    return res.json();
  }

  let routes;
  try {
    routes = await loadJSON('data/routes.json');
  } catch (e) {
    statusEl.textContent = e.message;
    return;
  }

  statusEl.textContent = `נטענו ${routes.length} מסלולים`;

  const routeMap = {};
  const DEFAULT_STYLE  = { weight: 4, opacity: 0.85 };
  const SELECTED_STYLE = { weight: 7, opacity: 1.0 };
  let selectedRouteId = null;
  
  function selectRoute(routeId, doFit = false) {
    const line = routeMap[routeId];
    if (!line) return;
    if (selectedRouteId && routeMap[selectedRouteId]) {
      routeMap[selectedRouteId].setStyle(DEFAULT_STYLE);
    }
    selectedRouteId = routeId;
    line.setStyle(SELECTED_STYLE);
    line.bringToFront();
    if (doFit) {
      map.fitBounds(line.getBounds(), { padding: [30, 30] });
    }
  }

  for (const r of routes) {
    try {
      const geom = await loadJSON(`data/${r.geometry_file}`);
      if (!geom.coordinates) continue;
      const latlngs = geom.coordinates.map(([lon, lat]) => [lat, lon]);
      if (latlngs.length < 2) continue;

      const line = L.polyline(latlngs, { weight: 4, opacity: 0.85 }).addTo(routesLayer);
      line.bindTooltip(r.name, { sticky: true });
      routeMap[r.id] = line;
      line.on('click', (e) => {
        L.DomEvent.stopPropagation(e); 
        selectRoute(r.id, true);
        showPreview(r.id, routes);
      });
    } catch (e) {
      console.warn('Route failed:', r.id, e.message);
    }
  }

  const byRegion = {};
  routes.forEach(r => {
    const region = r.region || 'לא משויך';
    (byRegion[region] = byRegion[region] || []).push(r);
  });

  Object.keys(byRegion).sort((a, b) => a.localeCompare(b, 'he')).forEach(region => {
    const title = document.createElement('div');
    title.className = 'region-title';
    title.textContent = region;
    listEl.appendChild(title);
    byRegion[region].forEach(r => {
      const item = document.createElement('div');
      item.className = 'route-item';
      item.textContent = r.name;
      item.onclick = () => {
        selectRoute(r.id, true);
        showPreview(r.id, routes);
      };
      listEl.appendChild(item);
    });
  });

})();
</script>
</body>
</html>
