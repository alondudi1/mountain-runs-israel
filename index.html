<!doctype html>
<html lang="he">
<head>
  <meta charset="utf-8" />
  <title>×¨×™×¦×•×ª ×”×¨×™× ×‘×™×©×¨××œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    .app { display:flex; height:100vh; direction:rtl; }

    .sidebar { width:320px; border-left:1px solid #ddd; background:#fff; display:flex; flex-direction:column; }
    .sidebar-header { padding:12px; border-bottom:1px solid #eee; }
    .sidebar-title { font-weight:800; margin-bottom:8px; }
    .sidebar-search { width:100%; padding:8px 10px; border-radius:10px; border:1px solid #ccc; box-sizing:border-box; }
    .view-modes { display:flex; gap:12px; font-size:13px; margin-top:8px; }
    .status { margin-top:10px; font-size:12px; opacity:.8; line-height:1.4; }
    .status.ok { color: #0a7a2f; }
    .status.err { color: #b00020; }

    .routes { padding:8px; overflow:auto; flex:1; }
    .region-title { font-weight:800; margin:12px 4px 6px; opacity:.85; }
    .route-item { border:1px solid #ddd; border-radius:10px; padding:8px 10px; margin:6px 0; cursor:pointer; user-select:none; }
    .route-item.active { background:#f2f2f2; border-color:#999; }
    .route-name { font-weight:800; font-size:14px; }
    .route-meta { font-size:12px; opacity:.75; margin-top:2px; }

    #map { flex:1; }

    .leaflet-tooltip.route-label {
      background:#fff; border:1px solid #aaa; padding:4px 6px; border-radius:6px; font-size:13px;
    }

    @media(max-width:800px){
      .app{flex-direction:column;}
      .sidebar{width:100%; height:40vh; border-left:none; border-bottom:1px solid #ddd;}
      #map{height:60vh;}
    }
  </style>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">××¡×œ×•×œ×™×</div>

      <input id="search" class="sidebar-search" placeholder="×—×™×¤×•×©â€¦"
             autocomplete="off" autocapitalize="off" spellcheck="false" name="route-search"/>

      <div class="view-modes">
        <label><input type="radio" name="mode" value="region" checked> ×œ×¤×™ ××–×•×¨</label>
        <label><input type="radio" name="mode" value="distance"> ×œ×¤×™ ××•×¨×š</label>
      </div>

      <div id="status" class="status">×˜×•×¢×Ÿ × ×ª×•× ×™×â€¦</div>
    </div>

    <div id="routes" class="routes"></div>
  </aside>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
window.addEventListener('load', async () => {
  const ISRAEL_BOUNDS = [[29.4,34.2],[33.3,35.9]];
  const statusEl = document.getElementById('status');

  const map = L.map('map');
  map.fitBounds(ISRAEL_BOUNDS);

  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19});
  const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19});
  osm.addTo(map);

  const routesLayer = L.layerGroup().addTo(map);
  const notesLayer  = L.layerGroup();

  async function loadJSON(path){
    const res = await fetch(path, { cache:'no-store' });
    if(!res.ok) throw new Error(`×˜×¢×™× ×ª ${path} × ×›×©×œ×” (${res.status})`);
    return res.json();
  }

  let routesGeo, notesGeo;
 let routes, notesGeo;

  try {
    routes   = await loadJSON('data/routes.json');   // ğŸ‘ˆ ×—×“×©
    notesGeo = await loadJSON('data/notes.geojson'); // × ×©××¨ ××•×ª×• ×“×‘×¨
  } catch (e) {
    statusEl.className = 'status err';
    statusEl.textContent = e.message;
    return;
  }


  const notesByRoute = {};
  (notesGeo.features || []).forEach(f=>{
    const id = f?.properties?.route_id;
    if(!id) return;
    (notesByRoute[id] = notesByRoute[id] || []).push(f);
  });

  function clearNotes(){
    notesLayer.clearLayers();
    if(map.hasLayer(notesLayer)) map.removeLayer(notesLayer);
  }

  function showNotes(id){
    clearNotes();
    (notesByRoute[id] || []).forEach(f=>{
      const coords = f?.geometry?.coordinates;
      if(!coords || coords.length < 2) return;
      const [lon,lat] = coords;
      const p = f.properties || {};
      L.marker([lat,lon]).addTo(notesLayer)
        .bindPopup(`<b>${p.title || '×”×¢×¨×”'}</b><br>${p.text || ''}`);
    });
    if(notesLayer.getLayers().length) notesLayer.addTo(map);
  }

  // ××¤×¢× ×— LineString / MultiLineString ×œ×¡×˜ LatLngs
  function geometryToLatLngs(geom){
    if(!geom) return null;
    if(geom.type === 'LineString') {
      return (geom.coordinates || []).map(([lon,lat])=>[lat,lon]);
    }
    if(geom.type === 'MultiLineString') {
      // × ×—×‘×¨ ×”×›×•×œ ×œ×¨×©×™××” ××—×ª ×œ×¦×•×¨×š fitBounds/×¦×™×•×¨ ×¤×©×•×˜
      const flat = [];
      (geom.coordinates || []).forEach(line=>{
        (line || []).forEach(([lon,lat])=>flat.push([lat,lon]));
      });
      return flat;
    }
    return null;
  }

  const routeMap = {}; // id->polyline
  const routes = (routesGeo.features || []).map(f=>{
    const p = f.properties || {};
    const id = String(p.id || '').trim();
    const name = String(p.name || '××¡×œ×•×œ').trim();
    const region = String(p.region || '×œ× ××©×•×™×š').trim();
    const distance_km = (p.distance_km != null && p.distance_km !== '') ? Number(p.distance_km) : null;

    const latlngs = geometryToLatLngs(f.geometry);
    if(!id || !latlngs || latlngs.length < 2) return null;

    const line = L.polyline(latlngs,{weight:4}).addTo(routesLayer);
    line.bindTooltip(name,{sticky:true,className:'route-label'});
    routeMap[id] = line;
    line.on('click',()=>focusRoute(id));

    return { id, name, region, distance_km };
  }).filter(Boolean);

  statusEl.className = 'status ok';
  statusEl.textContent = `× ×˜×¢× ×• ${routes.length} ××¡×œ×•×œ×™×, ${notesGeo.features?.length || 0} ×”×¢×¨×•×ª.`;

  if(routes.length === 0) {
    statusEl.className = 'status err';
    statusEl.textContent = '×œ× × ××¦××• ××¡×œ×•×œ×™× ×‘×§×•×‘×¥ routes.geojson (×‘×“×•×§: id, geometry, LineString).';
    return;
  }

  // Sidebar
  const routesEl = document.getElementById('routes');
  const searchEl = document.getElementById('search');

  let mode = 'region';
  let activeId = null;

  function highlight(id){
    activeId = id;
    routesEl.querySelectorAll('.route-item').forEach(el=>{
      el.classList.toggle('active', el.dataset.id === id);
    });
  }

  function focusRoute(id){
    const line = routeMap[id];
    if(!line) return;
    map.fitBounds(line.getBounds(),{padding:[30,30]});
    showNotes(id);
    highlight(id);
  }

  function addItem(r){
    const d = document.createElement('div');
    d.className='route-item';
    d.dataset.id=r.id;
    if(r.id===activeId) d.classList.add('active');
    const distTxt = (typeof r.distance_km === 'number' && !Number.isNaN(r.distance_km)) ? ` | ${r.distance_km} ×§×´×` : '';
    d.innerHTML = `<div class="route-name">${r.name}</div>
                   <div class="route-meta">${r.region}${distTxt}</div>`;
    d.onclick=()=>focusRoute(r.id);
    routesEl.appendChild(d);
  }

  function render(){
    const q = (searchEl.value || '').toLowerCase().trim();
    routesEl.innerHTML='';

    const list = routes.filter(r=>{
      const n = (r.name || '').toLowerCase();
      const rg = (r.region || '').toLowerCase();
      return !q || n.includes(q) || rg.includes(q);
    });

    if(mode === 'region'){
      const groups = {};
      list.forEach(r => (groups[r.region] = groups[r.region] || []).push(r));
      Object.keys(groups).sort((a,b)=>a.localeCompare(b,'he')).forEach(region=>{
        const h=document.createElement('div');
        h.className='region-title';
        h.textContent=region;
        routesEl.appendChild(h);
        groups[region].forEach(addItem);
      });
    } else {
      list.slice().sort((a,b)=>{
        const ad = (typeof a.distance_km === 'number' && !Number.isNaN(a.distance_km)) ? a.distance_km : 1e9;
        const bd = (typeof b.distance_km === 'number' && !Number.isNaN(b.distance_km)) ? b.distance_km : 1e9;
        return ad - bd;
      }).forEach(addItem);
    }
  }

  render();
  searchEl.addEventListener('input', render);

  document.querySelectorAll('input[name="mode"]').forEach(i=>{
    i.addEventListener('change', ()=>{
      mode = document.querySelector('input[name="mode"]:checked').value;
      render();
    });
  });

  // Controls
  L.control.layers({'××¤×”':osm,'×œ×•×•×™×™×Ÿ':sat},{'××¡×œ×•×œ×™×':routesLayer,'×”×¢×¨×•×ª':notesLayer}).addTo(map);

  const home=L.control({position:'topleft'});
  home.onAdd=()=>{
    const d=L.DomUtil.create('div','leaflet-bar leaflet-control');
    const a=L.DomUtil.create('a','',d);
    a.href='#'; a.title='×—×–×¨×” ×œ×›×œ ×™×©×¨××œ'; a.innerHTML='â†º';
    a.style.fontSize='18px'; a.style.lineHeight='30px'; a.style.textAlign='center';
    L.DomEvent.disableClickPropagation(d);
    L.DomEvent.on(a,'click',(e)=>{
      L.DomEvent.preventDefault(e);
      map.fitBounds(ISRAEL_BOUNDS,{padding:[20,20]});
      clearNotes();
      highlight(null);
    });
    return d;
  };
  home.addTo(map);
});
</script>
</body>
</html>
