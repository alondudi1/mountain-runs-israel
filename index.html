<!doctype html>
<html lang="he">
<head>
  <meta charset="utf-8" />
  <title>ריצות הרים בישראל</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; width: 100vw; }

    .popup-title { font-weight: bold; margin-bottom: 6px; }

    .leaflet-tooltip.route-label {
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(0,0,0,0.2);
      padding: 4px 6px;
      border-radius: 6px;
      font-size: 13px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.15);
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    window.addEventListener('load', async () => {

      /* ===============================
         הגדרות כלליות
         =============================== */
      const ISRAEL_BOUNDS = [[29.4, 34.2], [33.3, 35.9]];

      const map = L.map('map');
      map.fitBounds(ISRAEL_BOUNDS);

      /* ===============================
         שכבות בסיס
         =============================== */
      const osm = L.tileLayer(
        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }
      );

      const esriSat = L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        { maxZoom: 19, attribution: 'Tiles &copy; Esri' }
      );

      osm.addTo(map);

      /* ===============================
         שכבות תוכן
         =============================== */
      const routesLayer = L.layerGroup().addTo(map);
      const notesLayer  = L.layerGroup();

      /* ===============================
         טעינת נתונים
         =============================== */
      async function loadJSON(path) {
        const res = await fetch(path, { cache: 'no-store' });
        if (!res.ok) throw new Error(`Failed to load ${path}`);
        return res.json();
      }

      const routesGeo = await loadJSON('./data/routes.geojson');
      const notesGeo  = await loadJSON('./data/notes.geojson');

      // אינדקס הערות לפי route_id
      const notesByRoute = new Map();
      notesGeo.features.forEach(f => {
        const rid = f.properties.route_id;
        if (!notesByRoute.has(rid)) notesByRoute.set(rid, []);
        notesByRoute.get(rid).push(f);
      });

      function clearNotes() {
        notesLayer.clearLayers();
        if (map.hasLayer(notesLayer)) map.removeLayer(notesLayer);
      }

      function showNotes(routeId) {
        clearNotes();
        const arr = notesByRoute.get(routeId) || [];
        arr.forEach(f => {
          const [lon, lat] = f.geometry.coordinates;
          const p = f.properties;
          L.marker([lat, lon]).addTo(notesLayer).bindPopup(
            `<div class="popup-title">${p.title}</div>${p.text}`
          );
        });
        if (arr.length) notesLayer.addTo(map);
      }

      /* ===============================
         ציור מסלולים
         =============================== */
      routesGeo.features.forEach(f => {
        const p = f.properties;
        const latlngs = f.geometry.coordinates.map(([lon, lat]) => [lat, lon]);

        const line = L.polyline(latlngs, { weight: 4 }).addTo(routesLayer);
        line.bindTooltip(p.name, { sticky: true, className: 'route-label' });

        line.on('click', () => {
          map.fitBounds(line.getBounds(), { padding: [30, 30] });
          showNotes(p.id);
          line.bindPopup(`<div class="popup-title">${p.name}</div>${p.region || ''}`).openPopup();
        });
      });

      /* ===============================
         בקרות שכבות
         =============================== */
      L.control.layers(
        { 'מפה': osm, 'לוויין': esriSat },
        { 'מסלולים': routesLayer, 'הערות למסלול נבחר': notesLayer },
        { collapsed: false }
      ).addTo(map);

      /* ===============================
         כפתור "כל ישראל" – עובד בוודאות
         =============================== */
      // כפתור חזרה לתצוגת כל ישראל – מתחת לזום
const homeControl = L.control({ position: 'topleft' });

homeControl.onAdd = function () {
  const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');

  const btn = L.DomUtil.create('a', '', container);
  btn.href = '#';
  btn.title = 'חזרה לכל ישראל';

  // אייקון חץ חזרה (נראה טוב בכל מערכת)
  btn.innerHTML = '⤺';
  btn.style.fontSize = '16px';
  btn.style.lineHeight = '28px';
  btn.style.textAlign = 'center';


  // למנוע גרירת מפה / זום בלחיצה
  L.DomEvent.disableClickPropagation(container);
  L.DomEvent.on(btn, 'click', (e) => {
    L.DomEvent.preventDefault(e);
    map.fitBounds(ISRAEL_BOUNDS, { padding: [20, 20] });
    clearNotes();
  });

  return container;
};

homeControl.addTo(map);


    });
  </script>
</body>
</html>
