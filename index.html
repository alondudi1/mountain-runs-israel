<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Mountain Runs Israel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
    #app { display: flex; height: 100vh; flex-direction: row-reverse; }
    #map { flex: 1; }
    #sidebar {
        width: 320px; border-left: 1px solid #ddd; padding: 10px;
        overflow-y: auto; background: #fff; box-sizing: border-box;
        position: relative; z-index: 1000;
    }
    .region-title { font-weight: 800; margin: 14px 0 6px; opacity: .85; }
    .route-item { padding: 8px 10px; cursor: pointer; border-bottom: 1px solid #eee; user-select: none; }
    .route-item:hover { background: #f5f5f5; }
    .status { font-size: 12px; color: #666; margin-top: 10px; line-height: 1.4; }
    .leaflet-tooltip.route-label { background: #fff; border: 1px solid #aaa; padding: 4px 6px; border-radius: 6px; font-size: 13px; }

    .route-preview {
      position: fixed; right: 16px; bottom: 16px; transform: translateY(120%);
      opacity: 0; width: 360px; max-width: calc(100% - 32px);
      background: #fff; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25);
      padding: 16px; transition: transform 0.45s cubic-bezier(.2,.8,.2,1), opacity 0.35s ease;
      z-index: 1000;
    }
    .route-preview.show { transform: translateY(0); opacity: 1; }
    .route-preview.hidden { display: none; }
    #previewBtn { width: 100%; border: none; background: #d11; color: #fff; border-radius: 10px; padding: 8px; font-weight: 700; cursor: pointer; }
  </style>
</head>

<body>
  <div id="app">
    <div id="map"></div>
    <div id="sidebar">
      <div style="font-weight:800; margin-bottom:8px;">מסלולים</div>
      <div id="routesList"></div>
      <div class="status" id="status">טוען…</div>
    </div>
  </div>

  <div id="routePreview" class="route-preview hidden">
    <div style="font-weight:800;" id="previewTitle"></div>
    <div style="font-size:13px; color:#555; margin-bottom:10px;" id="previewMeta"></div>
    <button id="previewBtn">לפרטי המסלול →</button>
  </div>

  <script>
  window.addEventListener('load', async () => {
    const statusEl = document.getElementById('status');
    const listEl = document.getElementById('routesList');
    const ISRAEL_VIEW = { center: [31.8, 35.0], zoom: 8 };
    
    const map = L.map('map').setView(ISRAEL_VIEW.center, ISRAEL_VIEW.zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const routesLayer = L.layerGroup().addTo(map);

    async function loadJSON(path) {
      const res = await fetch(path, { cache: 'no-store' });
      return res.json();
    }

    const routes = await loadJSON('data/routes.json');
    const routeMap = {};
    const DEFAULT_STYLE = { weight: 4, opacity: 0.85, color: '#d11' };
    const SELECTED_STYLE = { weight: 7, opacity: 1.0, color: '#d11' };
    let selectedRouteId = null;

    function selectRoute(routeId, doFit = false) {
      const layer = routeMap[routeId];
      if (!layer) return;

      if (selectedRouteId && routeMap[selectedRouteId]) {
        routeMap[selectedRouteId].setStyle(DEFAULT_STYLE);
      }

      selectedRouteId = routeId;
      layer.setStyle(SELECTED_STYLE);
      if (layer.bringToFront) layer.bringToFront();

      if (doFit) {
        const bounds = layer.getBounds();
        if (bounds.isValid()) map.fitBounds(bounds, { padding: [40, 40] });
      }

      const r = routes.find(x => x.id === routeId);
      if (r) {
        document.getElementById('previewTitle').textContent = r.name;
        document.getElementById('previewMeta').textContent = `${r.region || ''} • ${r.distance_km || '?'} ק״מ`;
        const preview = document.getElementById('routePreview');
        preview.classList.remove('hidden');
        setTimeout(() => preview.classList.add('show'), 10);
        document.getElementById('previewBtn').onclick = () => window.location.href = `route.html?id=${routeId}`;
      }
    }

    // ציור המסלולים
    for (const r of routes) {
      try {
        let path = r.geometry_file;
        const isGPX = path.toLowerCase().endsWith('.gpx');
        const fullPath = isGPX ? `data/gpx/${path}` : `data/json/${path}`;

        if (isGPX) {
          new L.GPX(fullPath, {
            async: true,
            polyline_options: DEFAULT_STYLE,
            marker_options: { startIconUrl: null, endIconUrl: null, shadowUrl: null }
          }).on('loaded', function(e) {
            const layer = e.target;
            layer.bindTooltip(r.name, { sticky: true, className: 'route-label' });
            layer.on('click', (ev) => { L.DomEvent.stopPropagation(ev); selectRoute(r.id, true); });
            routeMap[r.id] = layer;
            layer.addTo(routesLayer);
          });
        } else {
          const geom = await loadJSON(fullPath);
          let coords = [];
          if (geom.type === 'LineString') coords = geom.coordinates.map(c => [c[1], c[0]]);
          else if (geom.type === 'MultiLineString') geom.coordinates.forEach(l => l.forEach(c => coords.push([c[1], c[0]])));
          
          if (coords.length >= 2) {
            const line = L.polyline(coords, DEFAULT_STYLE).addTo(routesLayer);
            line.bindTooltip(r.name, { sticky: true, className: 'route-label' });
            line.on('click', (ev) => { L.DomEvent.stopPropagation(ev); selectRoute(r.id, true); });
            routeMap[r.id] = line;
          }
        }
      } catch (e) { console.warn('Error loading:', r.id); }
    }

    // סיידבר
    const byRegion = {};
    routes.forEach(r => { (byRegion[r.region || 'אחר'] = byRegion[r.region || 'אחר'] || []).push(r); });
    listEl.innerHTML = '';
    Object.keys(byRegion).sort().forEach(region => {
      const t = document.createElement('div'); t.className = 'region-title'; t.textContent = region;
      listEl.appendChild(t);
      byRegion[region].forEach(r => {
        const i = document.createElement('div'); i.className = 'route-item'; i.textContent = r.name;
        i.onclick = () => selectRoute(r.id, true);
        listEl.appendChild(i);
      });
    });

    statusEl.textContent = `מוכן. ${routes.length} מסלולים.`;
  });
  // משתנה לשמירת המסלול שנבחר כרגע
    let currentSelectedId = null;

    function selectRoute(id, zoomTo = true) {
      const routeData = routes.find(r => r.id === id);
      const layer = routeMap[id];

      if (!routeData || !layer) return;

      // איפוס עיצוב למסלול הקודם
      if (currentSelectedId && routeMap[currentSelectedId]) {
        routeMap[currentSelectedId].setStyle(DEFAULT_STYLE);
      }

      // הדגשת המסלול הנבחר
      layer.setStyle(SELECTED_STYLE);
      layer.bringToFront();
      currentSelectedId = id;

      // עדכון כרטיס התצוגה המקדימה (Preview Card)
      const preview = document.getElementById('routePreview');
      const title = document.getElementById('previewTitle');
      const meta = document.getElementById('previewMeta');
      const btn = document.getElementById('previewBtn');

      title.textContent = routeData.name;
      meta.textContent = `${routeData.distance || ''} ק"מ | טיפוס: ${routeData.climb || ''} מ'`;
      
      // הצגת הכרטיס
      preview.classList.remove('hidden');
      setTimeout(() => preview.classList.add('show'), 10);

      // קישור לכפתור (אם יש דף נפרד)
      btn.onclick = () => {
        window.location.href = `route.html?id=${id}`;
      };

      // התמקדות במפה
      if (zoomTo) {
        if (layer.getBounds) {
          map.fitBounds(layer.getBounds(), { padding: [50, 50] });
        }
      }
    }

    // סגירת הכרטיס בלחיצה על מקום ריק במפה
    map.on('click', () => {
      if (currentSelectedId && routeMap[currentSelectedId]) {
        routeMap[currentSelectedId].setStyle(DEFAULT_STYLE);
      }
      document.getElementById('routePreview').classList.remove('show');
      setTimeout(() => document.getElementById('routePreview').classList.add('hidden'), 400);
      currentSelectedId = null;
    });
  </script>
</body>
</html>
