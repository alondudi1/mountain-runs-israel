<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Mountain Runs Israel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
    #app { display: flex; height: 100vh; flex-direction: row-reverse; }
    #map { flex: 1; }

    #sidebar {
      width: 320px;
      border-left: 1px solid #ddd;
      padding: 10px;
      overflow-y: auto;
      background: #fff;
      box-sizing: border-box;
    }

    .region-title {
      font-weight: 800;
      margin: 14px 0 6px;
      opacity: .85;
    }

    .route-item {
      padding: 8px 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .route-item:hover {
      background: #f5f5f5;
    }

    .status {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
    }

    @media (max-width: 800px) {
      #app { flex-direction: column; }
      #sidebar { width: 100%; height: 40vh; border-left: none; border-top: 1px solid #ddd; }
      #map { height: 60vh; }
    }
    .leaflet-top.leaflet-left .leaflet-control {
      margin-bottom: 6px;
    }
    /* ===== Preview Card ===== */
    .route-preview {
      position: fixed;
      right: 16px;
      bottom: 16px;
      width: 320px;
      max-width: calc(100% - 32px);
    
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      padding: 12px;
    
      z-index: 1200;
    
      transform: translateY(120%);
      opacity: 0;
      transition: transform 0.35s ease, opacity 0.25s ease;
    }
    
    .route-preview.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .route-preview.hidden { display: none; }
    
    .rp-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
    }
    
    .rp-title { font-weight: 800; font-size: 15px; margin-bottom: 4px; }
    .rp-meta  { font-size: 12px; color: #666; line-height: 1.3; }
    
    .rp-close {
      border: 0;
      background: transparent;
      cursor: pointer;
      font-size: 20px;
      line-height: 20px;
      padding: 4px 6px;
      color: #444;
    }
    
    .rp-btn {
      display: block;          /* ğŸ‘ˆ ×œ× inline */
      width: 100%;             /* ğŸ‘ˆ ×¨×•×—×‘ ××œ× */
      box-sizing: border-box;
    
      margin-top: 10px;
      padding: 10px 12px;
    
      background: #d32f2f;
      color: #fff;
      text-decoration: none;
      font-weight: 700;
      font-size: 14px;
      text-align: center;
    
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,.2);
    }

    
    .rp-btn:hover { background: #b71c1c; }

    .rp-meta:empty { display: none; }

  </style>
</head>

<body>
<div id="app">
  <div id="map"></div>
  <div id="sidebar">
    <div style="font-weight:800; margin-bottom:8px;">5××¡×œ×•×œ×™×</div>
    <div id="routesList"></div>
    <div class="status" id="status">×˜×•×¢×Ÿâ€¦</div>
  </div>
</div>

  <!-- Route Preview Card -->
  <div id="routePreview" class="route-preview hidden">
    <div class="rp-top">
      <div class="rp-text">
        <div id="previewTitle" class="rp-title"></div>
        <div id="previewMeta" class="rp-meta"></div>
      </div>
      <button id="previewClose" class="rp-close" title="×¡×’×•×¨">Ã—</button>
    </div>
  
    <a id="previewBtn" class="rp-btn" href="#">×œ×¤×¨×˜×™ ×”××¡×œ×•×œ â†’</a>
  </div>

<script>
(async function () {

  const statusEl = document.getElementById('status');
  const listEl   = document.getElementById('routesList');

  // ===== Preview Card refs =====
  const preview = document.getElementById('routePreview');
  const titleEl = document.getElementById('previewTitle');
  const metaEl  = document.getElementById('previewMeta');
  const btnEl   = document.getElementById('previewBtn');
  const closeEl = document.getElementById('previewClose');
  
  function hidePreview() {
    preview.classList.remove('show');
    setTimeout(() => preview.classList.add('hidden'), 250);
  }
  
  function showPreview(routeId, routes) {
    const r = routes.find(x => x.id === routeId);
    if (!r) return;
  
    titleEl.textContent = r.name || routeId;
  
    
  
    btnEl.href = `route.html?id=${encodeURIComponent(routeId)}`;
  
    preview.classList.remove('hidden');
    requestAnimationFrame(() => preview.classList.add('show'));
  }
  
  closeEl.addEventListener('click', hidePreview);

  
  if (!window.L) {
    statusEl.textContent = 'Leaflet ×œ× × ×˜×¢×Ÿ';
    return;
  }

  // ===== ××¤×” =====
  const ISRAEL_VIEW = { center: [31.8, 35.0], zoom: 8 };

  const map = L.map('map').setView(ISRAEL_VIEW.center, ISRAEL_VIEW.zoom);

  map.on('click', () => hidePreview());

  // ===== ×›×¤×ª×•×¨ ×—×–×¨×” ×œ×ª×¦×•×’×ª ×¤×ª×™×—×” =====
  const backControl = L.control({ position: 'topleft' });
  
  backControl.onAdd = function () {
    const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
  
    const btn = L.DomUtil.create('a', '', container);
    btn.href = '#';
    btn.title = '×—×–×¨×” ×œ×›×œ ×™×©×¨××œ';
    btn.innerHTML = 'â†º';   // ××™×™×§×•×Ÿ ×—×¥ ×—×–×¨×”
    btn.style.fontSize = '18px';
    btn.style.lineHeight = '30px';
    btn.style.textAlign = 'center';
    btn.style.width = '30px';
    btn.style.height = '30px';
  
    // ×œ×× ×•×¢ ×§×œ×™×§×™× ×©××–×™×–×™× ××ª ×”××¤×”
    L.DomEvent.disableClickPropagation(container);
  
    L.DomEvent.on(btn, 'click', (e) => {
      L.DomEvent.preventDefault(e);
      map.setView(ISRAEL_VIEW.center, ISRAEL_VIEW.zoom);
    });
  
    return container;
  };

backControl.addTo(map);

 // ===== ×©×›×‘×•×ª ××¤×” (Base Layers) =====
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap'
  });
  
  const satellite = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { maxZoom: 19, attribution: 'Tiles Â© Esri' }
  );
  
  const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
    maxZoom: 17,
    attribution: 'Â© OpenTopoMap'
  });

  // ×”×•×¡×¤×ª ××¤×ª ×¡×™××•×Ÿ ×©×‘×™×œ×™× (IHM)
  const ihm = L.tileLayer('https://israelhiking.osm.org.il/tiles/IsraelHiking/{z}/{x}/{y}.png', {
    maxZoom: 16,
    attribution: 'Â© Israel Hiking Map'
  });

  // ×”×’×“×¨×ª IHM ×›×‘×¨×™×¨×ª ××—×“×œ ×©× ×˜×¢× ×ª ×¨××©×•× ×”
  ihm.addTo(map);
  
  // ×ª×¤×¨×™×˜ ×‘×—×™×¨×ª ××¤×•×ª ××¢×•×“×›×Ÿ
  L.control.layers(
    { 
      '×¡×™××•×Ÿ ×©×‘×™×œ×™× (IHM)': ihm, 
      '×˜×•×¤×•×’×¨×¤×™': topo, 
      '×œ×•×•×™×™×Ÿ': satellite, 
      '××¤×ª ×¨×—×•×‘×•×ª (OSM)': osm 
    },
    null,
    { position: 'topright' }
  ).addTo(map);


  const routesLayer = L.layerGroup().addTo(map);

  // ===== ×˜×¢×™× ×ª JSON =====
  async function loadJSON(path) {
    const res = await fetch(path, { cache: 'no-store' });
    if (!res.ok) throw new Error(`Failed to load ${path}`);
    return res.json();
  }

  let routes;
  try {
    routes = await loadJSON('data/routes.json');
  } catch (e) {
    statusEl.textContent = e.message;
    return;
  }

  statusEl.textContent = `× ×˜×¢× ×• ${routes.length} ××¡×œ×•×œ×™×`;

  // ===== ×¦×™×•×¨ ××¡×œ×•×œ×™× =====
  const routeMap = {};

  // ===== Styles + selection =====
  const DEFAULT_STYLE  = { weight: 4, opacity: 0.85 };
  const SELECTED_STYLE = { weight: 7, opacity: 1.0 };
  
  let selectedRouteId = null;
  
  function selectRoute(routeId, doFit = false) {
    const line = routeMap[routeId];
    if (!line) return;
  
    // ×”×—×–×¨×ª ×”×§×•×“× ×œ×‘×¨×™×¨×ª ××—×“×œ
    if (selectedRouteId && routeMap[selectedRouteId]) {
      routeMap[selectedRouteId].setStyle(DEFAULT_STYLE);
    }
  
    // ×”×“×’×©×ª ×”× ×‘×—×¨
    selectedRouteId = routeId;
    line.setStyle(SELECTED_STYLE);
    line.bringToFront();
  
    if (doFit) {
      map.fitBounds(line.getBounds(), { padding: [30, 30] });
    }
}

  for (const r of routes) {
    try {
      const geom = await loadJSON(`data/${r.geometry_file}`);

      if (!geom.coordinates) continue;

      const latlngs = geom.coordinates.map(([lon, lat]) => [lat, lon]);
      if (latlngs.length < 2) continue;

      const line = L.polyline(latlngs, {
        weight: 4,
        opacity: 0.85
      }).addTo(routesLayer);

      line.bindTooltip(r.name, { sticky: true });

      routeMap[r.id] = line;

      line.on('click', (e) => {
  // ×”×©×•×¨×” ×”×–×• ×”×™× ×”×§×¡× - ×”×™× ××•× ×¢×ª ××”×œ×—×™×¦×” ×œ×”×’×™×¢ ×œ××¤×”
        L.DomEvent.stopPropagation(e); 
        
        selectRoute(r.id, true);     // ××™×§×•×“ + ×”×“×’×©×”
        showPreview(r.id, routes);   // ×¤×ª×™×—×ª ×”×›×¨×˜×™×¡
      });


    } catch (e) {
      console.warn('Route failed:', r.id, e.message);
    }
  }

  // ===== ×¨×©×™××” ×œ×¤×™ ××–×•×¨ =====
  const byRegion = {};
  routes.forEach(r => {
    const region = r.region || '×œ× ××©×•×™×š';
    (byRegion[region] = byRegion[region] || []).push(r);
  });

  Object.keys(byRegion)
    .sort((a, b) => a.localeCompare(b, 'he'))
    .forEach(region => {

      const title = document.createElement('div');
      title.className = 'region-title';
      title.textContent = region;
      listEl.appendChild(title);

      byRegion[region].forEach(r => {
        const item = document.createElement('div');
        item.className = 'route-item';
        item.textContent = r.name;

        item.onclick = () => {
          selectRoute(r.id, true);     // ××™×§×•×“ + ×”×“×’×©×”
          showPreview(r.id, routes);   // ×¤×ª×™×—×ª ×”×›×¨×˜×™×¡
        };


        listEl.appendChild(item);
      });
    });

})();
</script>
</body>
</html>
