<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Mountain Runs Israel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
    #app { display: flex; height: 100vh; flex-direction: row-reverse; }
    #map { flex: 1; }

    #sidebar {
      width: 320px;
      border-left: 1px solid #ddd;
      padding: 10px;
      overflow-y: auto;
      background: #fff;
      box-sizing: border-box;
    }

    .region-title {
      font-weight: 800;
      margin: 14px 0 6px;
      opacity: .85;
    }

    .route-item {
      padding: 8px 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .route-item:hover {
      background: #f5f5f5;
    }

    .status {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
    }

    @media (max-width: 800px) {
      #app { flex-direction: column; }
      #sidebar { width: 100%; height: 40vh; border-left: none; border-top: 1px solid #ddd; }
      #map { height: 60vh; }
    }
    .leaflet-top.leaflet-left .leaflet-control {
      margin-bottom: 6px;
    }

  </style>
</head>

<body>
<div id="app">
  <div id="map"></div>
  <div id="sidebar">
    <div style="font-weight:800; margin-bottom:8px;">1מסלולים</div>
    <div id="routesList"></div>
    <div class="status" id="status">טוען…</div>
  </div>
</div>

<script>
(async function () {

  const statusEl = document.getElementById('status');
  const listEl   = document.getElementById('routesList');

  if (!window.L) {
    statusEl.textContent = 'Leaflet לא נטען';
    return;
  }

  // ===== מפה =====
  const ISRAEL_VIEW = { center: [31.8, 35.0], zoom: 8 };

  const map = L.map('map').setView(ISRAEL_VIEW.center, ISRAEL_VIEW.zoom);

  // ===== כפתור חזרה לתצוגת פתיחה =====
  const backControl = L.control({ position: 'topleft' });
  
  backControl.onAdd = function () {
    const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
  
    const btn = L.DomUtil.create('a', '', container);
    btn.href = '#';
    btn.title = 'חזרה לכל ישראל';
    btn.innerHTML = '↺';   // אייקון חץ חזרה
    btn.style.fontSize = '18px';
    btn.style.lineHeight = '30px';
    btn.style.textAlign = 'center';
    btn.style.width = '30px';
    btn.style.height = '30px';
  
    // למנוע קליקים שמזיזים את המפה
    L.DomEvent.disableClickPropagation(container);
  
    L.DomEvent.on(btn, 'click', (e) => {
      L.DomEvent.preventDefault(e);
      map.setView(ISRAEL_VIEW.center, ISRAEL_VIEW.zoom);
    });
  
    return container;
  };

backControl.addTo(map);

  // ===== שכבות מפה (Base Layers) =====
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap'
  });
  
  const satellite = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { maxZoom: 19, attribution: 'Tiles © Esri' }
  );
  
  const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
    maxZoom: 17,
    attribution: '© OpenTopoMap (SRTM, OSM contributors)'
  });
  
  // ברירת מחדל: osm
  osm.addTo(map);
  
  // תפריט בחירת מפות – ימין למעלה
  L.control.layers(
    { 'טופוגרפי': topo, 'לוויין': satellite, 'מפה': osm },
    null,
    { position: 'topright' }
  ).addTo(map);


  const routesLayer = L.layerGroup().addTo(map);

  // ===== טעינת JSON =====
  async function loadJSON(path) {
    const res = await fetch(path, { cache: 'no-store' });
    if (!res.ok) throw new Error(`Failed to load ${path}`);
    return res.json();
  }

  let routes;
  try {
    routes = await loadJSON('data/routes.json');
  } catch (e) {
    statusEl.textContent = e.message;
    return;
  }

  statusEl.textContent = `נטענו ${routes.length} מסלולים`;

  // ===== ציור מסלולים =====
  const routeMap = {};

  for (const r of routes) {
    try {
      const geom = await loadJSON(`data/${r.geometry_file}`);

      if (!geom.coordinates) continue;

      const latlngs = geom.coordinates.map(([lon, lat]) => [lat, lon]);
      if (latlngs.length < 2) continue;

      const line = L.polyline(latlngs, {
        weight: 4,
        opacity: 0.85
      }).addTo(routesLayer);

      line.bindTooltip(r.name, { sticky: true });

      routeMap[r.id] = line;

    } catch (e) {
      console.warn('Route failed:', r.id, e.message);
    }
  }

  // ===== רשימה לפי אזור =====
  const byRegion = {};
  routes.forEach(r => {
    const region = r.region || 'לא משויך';
    (byRegion[region] = byRegion[region] || []).push(r);
  });

  Object.keys(byRegion)
    .sort((a, b) => a.localeCompare(b, 'he'))
    .forEach(region => {

      const title = document.createElement('div');
      title.className = 'region-title';
      title.textContent = region;
      listEl.appendChild(title);

      byRegion[region].forEach(r => {
        const item = document.createElement('div');
        item.className = 'route-item';
        item.textContent = r.name;

        item.onclick = () => {
          const line = routeMap[r.id];
          if (!line) return;
          map.fitBounds(line.getBounds(), { padding: [30, 30] });
        };

        listEl.appendChild(item);
      });
    });

})();
</script>
</body>
</html>
