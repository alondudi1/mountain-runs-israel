<!doctype html>
<html lang="he">
<head>
  <meta charset="utf-8" />
  <title>ריצות הרים בישראל</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    .app { display:flex; height:100vh; direction:rtl; }

    /* Sidebar */
    .sidebar {
      width:320px;
      border-left:1px solid #ddd;
      background:#fff;
      display:flex;
      flex-direction:column;
    }
    .sidebar-header {
      padding:12px;
      border-bottom:1px solid #eee;
    }
    .sidebar-title { font-weight:800; margin-bottom:8px; }
    .sidebar-search {
      width:100%;
      padding:8px;
      margin-bottom:8px;
      border-radius:8px;
      border:1px solid #ccc;
    }
    .view-modes {
      display:flex;
      gap:12px;
      font-size:13px;
    }
    .routes { padding:8px; overflow:auto; flex:1; }

    .region-title {
      font-weight:800;
      margin:12px 4px 4px;
      opacity:.8;
    }
    .route-item {
      border:1px solid #ddd;
      border-radius:10px;
      padding:8px;
      margin:6px 0;
      cursor:pointer;
    }
    .route-item.active {
      background:#f2f2f2;
      border-color:#999;
    }
    .route-name { font-weight:700; font-size:14px; }
    .route-meta { font-size:12px; opacity:.75; }

    /* Map */
    #map { flex:1; }

    .leaflet-tooltip.route-label {
      background:#fff;
      border:1px solid #aaa;
      padding:4px 6px;
      border-radius:6px;
      font-size:13px;
    }

    @media(max-width:800px){
      .app{flex-direction:column;}
      .sidebar{width:100%; height:40vh; border-left:none; border-bottom:1px solid #ddd;}
      #map{height:60vh;}
    }
  </style>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">מסלולים</div>
      <input id="search" class="sidebar-search" placeholder="חיפוש…"/>

      <div class="view-modes">
        <label><input type="radio" name="mode" value="region" checked> לפי אזור</label>
        <label><input type="radio" name="mode" value="distance"> לפי אורך</label>
      </div>
    </div>
    <div id="routes" class="routes"></div>
  </aside>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
window.addEventListener('load', async () => {

  /* ---------- Map ---------- */
  const ISRAEL_BOUNDS = [[29.4,34.2],[33.3,35.9]];
  const map = L.map('map');
  map.fitBounds(ISRAEL_BOUNDS);

  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19});
  const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19});
  osm.addTo(map);

  const routesLayer = L.layerGroup().addTo(map);
  const notesLayer  = L.layerGroup();

  /* ---------- Load data ---------- */
  const routesGeo = await fetch('./data/routes.geojson').then(r=>r.json());
  const notesGeo  = await fetch('./data/notes.geojson').then(r=>r.json());

  const notesByRoute = {};
  notesGeo.features.forEach(f=>{
    const id=f.properties.route_id;
    (notesByRoute[id]=notesByRoute[id]||[]).push(f);
  });

  function clearNotes(){
    notesLayer.clearLayers();
    map.removeLayer(notesLayer);
  }

  function showNotes(id){
    clearNotes();
    (notesByRoute[id]||[]).forEach(f=>{
      const [lon,lat]=f.geometry.coordinates;
      L.marker([lat,lon])
        .addTo(notesLayer)
        .bindPopup(`<b>${f.properties.title}</b><br>${f.properties.text}`);
    });
    if(notesLayer.getLayers().length) notesLayer.addTo(map);
  }

  /* ---------- Draw routes ---------- */
  const routeMap = {};
  const routes = routesGeo.features.map(f=>{
    const p=f.properties;
    const latlngs=f.geometry.coordinates.map(([lon,lat])=>[lat,lon]);
    const line=L.polyline(latlngs,{weight:4}).addTo(routesLayer);
    line.bindTooltip(p.name,{sticky:true,className:'route-label'});
    routeMap[p.id]=line;

    line.on('click',()=>focusRoute(p.id));
    return {...p};
  });

  function focusRoute(id){
    const line=routeMap[id];
    if(!line) return;
    map.fitBounds(line.getBounds(),{padding:[30,30]});
    showNotes(id);
    highlight(id);
  }

  /* ---------- Sidebar ---------- */
  const routesEl=document.getElementById('routes');
  const searchEl=document.getElementById('search');
  let mode='region', activeId=null;

  function highlight(id){
    activeId=id;
    [...routesEl.children].forEach(el=>{
      el.classList.toggle('active',el.dataset.id===id);
    });
  }

  function render(){
    const q=searchEl.value.toLowerCase();
    routesEl.innerHTML='';

    let list=routes.filter(r=>
      r.name.toLowerCase().includes(q) || r.region.toLowerCase().includes(q)
    );

    if(mode==='region'){
      const groups={};
      list.forEach(r=>(groups[r.region]=groups[r.region]||[]).push(r));
      Object.keys(groups).sort().forEach(region=>{
        const h=document.createElement('div');
        h.className='region-title';
        h.textContent=region;
        routesEl.appendChild(h);
        groups[region].forEach(addItem);
      });
    }else{
      list.sort((a,b)=>(a.distance_km||999)-(b.distance_km||999))
          .forEach(addItem);
    }
  }

  function addItem(r){
    const d=document.createElement('div');
    d.className='route-item';
    d.dataset.id=r.id;
    if(r.id===activeId) d.classList.add('active');
    d.innerHTML=`<div class="route-name">${r.name}</div>
                 <div class="route-meta">${r.region} | ${r.distance_km||'?'} ק״מ</div>`;
    d.onclick=()=>focusRoute(r.id);
    routesEl.appendChild(d);
  }

  render();
  searchEl.oninput=render;
  document.querySelectorAll('input[name="mode"]').forEach(i=>{
    i.onchange=()=>{mode=i.value; render();}
  });

  /* ---------- Controls ---------- */
  L.control.layers({'מפה':osm,'לוויין':sat},{'מסלולים':routesLayer,'הערות':notesLayer}).addTo(map);

  const home=L.control({position:'topleft'});
  home.onAdd=()=>{
    const d=L.DomUtil.create('div','leaflet-bar');
    const a=L.DomUtil.create('a','',d);
    a.innerHTML='↺';
    a.style.fontSize='18px';
    a.onclick=e=>{
      e.preventDefault();
      map.fitBounds(ISRAEL_BOUNDS);
      clearNotes();
      highlight(null);
    };
    return d;
  };
  home.addTo(map);

});
</script>
</body>
</html>
