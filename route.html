window.addEventListener('load', async () => {
  const statusEl = document.getElementById('routeDescription');
  
  async function loadJSON(path) {
    const res = await fetch(path);
    if (!res.ok) throw new Error(`Failed to load: ${path}`);
    return res.json();
  }

  // 1. ×—×™×œ×•×¥ ×”-ID ××”-URL
  const params = new URLSearchParams(window.location.search);
  const routeId = params.get('id');

  if (!routeId) {
    document.getElementById('routeName').textContent = "××¡×œ×•×œ ×œ× × ××¦×";
    return;
  }

  try {
    // 2. ×˜×¢×™× ×ª ×¨×©×™××ª ×”××¡×œ×•×œ×™× ×•××¦×™××ª ×”××¡×œ×•×œ ×”×¡×¤×¦×™×¤×™
    const routes = await loadJSON('data/routes.json');
    const route = routes.find(r => r.id === routeId);

    if (!route) {
      document.getElementById('routeName').textContent = "××¡×œ×•×œ ×œ× × ××¦×";
      return;
    }

    // 3. ×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×”×˜×§×¡×˜ ×‘×“×£
    document.title = route.name;
    document.getElementById('routeName').textContent = route.name;
    document.getElementById('infoRegion').textContent = `ğŸ“ ××–×•×¨: ${route.region || 'â€”'}`;
    document.getElementById('infoDifficulty').textContent = `ğŸ”¥ ×§×•×©×™: ${route.difficulty || 'â€”'}`;
    document.getElementById('infoDistance').textContent = `ğŸ“ ××¨×—×§: ${route.distance || '--'} ×§"×`;
    document.getElementById('infoAscent').textContent = `â›°ï¸ ×˜×™×¤×•×¡: ${route.elevation || '--'} ×'`;
    document.getElementById('routeDescription').textContent = route.description || '××™×Ÿ ×ª×™××•×¨ ×–××™×Ÿ ×œ××¡×œ×•×œ ×–×”.';

    // 4. ××ª×—×•×œ ×”××¤×”
    const map = L.map('map').setView([31.8, 35.0], 8);

    // ×©×›×‘×•×ª ××¤×” (×›×•×œ×œ IHM ×”××ª×•×§× ×ª)
    const ihm = L.tileLayer('https://israelhiking.osm.org.il/Hebrew/Tiles/{z}/{x}/{y}.png', {
      maxZoom: 16,
      attribution: 'Â© Israel Hiking Map'
    }).addTo(map);

    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Â© Esri'
    });

    L.control.layers({ "×©×‘×™×œ×™× (IHM)": ihm, "×œ×•×•×™×™×Ÿ": satellite }, null, { position: 'topright' }).addTo(map);

    // 5. ×˜×¢×™× ×ª ×”×’×™××•××˜×¨×™×” (×”×§×•××•×¨×“×™× ×˜×•×ª) ×©×œ ×”××¡×œ×•×œ
    const geom = await loadJSON(`data/${route.geometry_file}`);
    
    if (geom && geom.coordinates) {
      const latlngs = geom.coordinates.map(([lon, lat]) => [lat, lon]);
      
      // ×¦×™×•×¨ ×”××¡×œ×•×œ ×¢×œ ×”××¤×”
      const polyline = L.polyline(latlngs, {
        color: '#d32f2f',
        weight: 5,
        opacity: 0.9
      }).addTo(map);

      // ×”×ª×××ª ×”××¤×” ×œ××¡×œ×•×œ (Zoom to fit)
      map.fitBounds(polyline.getBounds(), { padding: [40, 40] });
      
      // ×”×•×¡×¤×ª ×—×¦×™× ×œ×›×™×•×•×Ÿ ×”×¨×™×¦×” (×‘×××¦×¢×•×ª ×”×ª×•×¡×£ ×©×›×‘×¨ ×˜×¢× ×ª)
      L.polylineDecorator(polyline, {
        patterns: [
          { offset: '5%', repeat: '20%', symbol: L.Symbol.arrowHead({ pixelSize: 10, polygon: false, pathOptions: { stroke: true, color: '#fff' } }) }
        ]
      }).addTo(map);
    }

    // ×›×¤×ª×•×¨ ×”×•×¨×“×” (×× ×™×© ×œ×™× ×§ ×œ×§×•×‘×¥ GPX ×‘-JSON)
    if (route.gpx_file) {
      const downloadBtn = document.getElementById('downloadBtn');
      downloadBtn.style.cursor = 'pointer';
      downloadBtn.onclick = () => window.location.href = `data/${route.gpx_file}`;
      downloadBtn.style.color = '#d32f2f';
      downloadBtn.style.fontWeight = 'bold';
    }

  } catch (err) {
    console.error(err);
    document.getElementById('routeDescription').textContent = "×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”××¡×œ×•×œ.";
  }
});
